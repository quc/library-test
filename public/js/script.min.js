window.addEventListener("load",function(){window.app=function(t,o){"use strict";function e(){this.isLocalStorageAvailable=function(){try{var t="__test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(o){return!1}}(),this.init()}function i(){this.body=o.body,this.content=o.getElementById("content"),this.isTouch="ontouchstart"in t&&!1,this.startEvent=this.isTouch?"touchstart":"mousedown",this.moveEvent=this.isTouch?"touchmove":"mousemove",this.endEvent=this.isTouch?"touchend":"mouseup",this.fucusedInput="",this.oldInput="",this.cssAction=[{name:"sort_button",action:function(t,o){n.toggleSortList(t,o)}},{name:"sort_reverse",action:function(t,o){n.sortReverse(t,o)}},{name:"sort_list",action:function(t,o){n.selectSortType(t,o)}},{name:"add_book",action:function(t,o){n.addNewBook(t,o)}},{name:"popup_wrapper",action:function(t,o){}},{name:"popup",action:function(t,o){n.looseFocusFromInput(t,o)}},{name:"close",action:function(t,o){n.checkBeforeClosePopup(t,o)}},{name:"cancel",action:function(t,o){n.clearBookPopup(t,o)}},{name:"save",action:function(t,o){n.saveBookData(t,o)}},{name:"form_input",action:function(t,o){n.focusOnInput(t,o)}},{name:"live_result",action:function(t,o){}},{name:"edit_list",action:function(t,o){}},{name:"remove_list",action:function(t,o){}}];var e=0,i=0,s=[];for(e=0;e<this.cssAction.length;e++)for(s=this.body.querySelectorAll("."+this.cssAction[e].name),i=0;i<s.length;i++)s[i].addEventListener(this.endEvent,this.handler);this.createLiveResults(),this.setSorting()}e.prototype.init=function(){if(!this.getFromLocalStorage().length){for(var t,o,e=["Marsless","The Journey Dragoon","Beyond the Flaming Daughter","Man of Window","The Nothing-Room","The North","The GuardAir","World Options","Great Damnations","Mysterious Childrens"],i=["Runny Snicker","Buttercup Buffalo","Dinky Gross","P.G. Boss","Crusty","Greasy Potato","Lemur","Tofu","Lumpy Hamster","Wacky Rhino"],s=["Comedy","Drama","Non-fiction","Realistic fiction","Romance novel","Satire","Tragedy","Tragicomedy","Horror"],n=["978-5-8459-2069-0","978-5-496-01545-5","978-5-8459-2081-2","978-5-699-79119-4","978-5-8459-1922-9","978-5-699-67603-3","978-1-449-32339-4","978-5-8459-1937-3","978-5-496-01592-9","978-5-496-01441-0"],a=["http://static.ozone.ru/multimedia/books_covers/1011125111.jpg","http://static2.ozone.ru/multimedia/books_covers/1011362787.jpg","http://static2.ozone.ru/multimedia/books_covers/1014275857.jpg","http://static1.ozone.ru/multimedia/books_covers/1011071764.jpg","http://static2.ozone.ru/multimedia/books_covers/1008879389.jpg","http://static.ozone.ru/multimedia/books_covers/1010370201.jpg","http://static2.ozone.ru/multimedia/books_covers/1008879298.jpg","http://static1.ozone.ru/multimedia/books_covers/1014492964.jpg","http://static.ozone.ru/multimedia/books_covers/1014478210.jpg","http://static2.ozone.ru/multimedia/books_covers/1014478168.jpg"],r={},l=[],c=0;c<e.length;c++){r={},r.author=[],r.genre=[],r.title=e[c];for(var u=0,h=Math.floor(3*Math.random())+1;h>u;u++)o=Math.floor(Math.random()*i.length),t=Math.floor(Math.random()*s.length),-1===r.genre.indexOf(s[t])&&r.genre.push(s[t]),-1===r.author.indexOf(i[o])&&r.author.push(i[o]);r.year=Math.floor(47*Math.random())+1970,r.ISBN=n.splice(Math.floor(Math.random()*n.length),1)[0],r.image=a.splice(Math.floor(Math.random()*a.length),1)[0],r.views=0,l.push(r)}this.setLibrarySettings({sorting:{type:"title",reverse:!1}}),this.liveResultInit(l),this.setToLocalStorage(l)}},e.prototype.setToLocalStorage=function(t,o){this.isLocalStorageAvailable&&(t=t||[{}],o=o||"books",localStorage.setItem(o,JSON.stringify(t)))},e.prototype.getFromLocalStorage=function(t){if(this.isLocalStorageAvailable){t=t||"books";var o=localStorage.getItem(t);return JSON.parse(o)||[]}},e.prototype.newBook=function(t){t=t||{};var o=this.getFromLocalStorage();return this.isBookExist(t)?(this.editBookData(t.ISBN,t),void console.log("Book is already exist")):(t.title=t.title||"Unknown",t.author=t.author||["Unknown"],t.genre=t.genre||["Unknown"],t.year=t.year||"Unknown",t.ISBN=t.ISBN||"Unknown",t.views=t.views||"0",o.push(t),this.setToLocalStorage(o),t)},e.prototype.isBookExist=function(t,o){return o=o||this.getFromLocalStorage(),o&&0!==o.length?this.getBookByISBN(t.ISBN,o)?!0:!1:void 0},e.prototype.getBookByISBN=function(t,o){if(o=o||this.getFromLocalStorage(),0!==o.length){for(var e=0,i=o.length;i>e;e++)if(o[e].ISBN===t)return{book:o[e],id:e};return!1}},e.prototype.editBookData=function(t,o){var e=this.getBookByISBN(t),i=e.book||{},s=this.getFromLocalStorage(),n=i.ISBN;if(e){for(var a in i)if(i.hasOwnProperty(a))for(var r in o)o.hasOwnProperty(r)&&a===r&&(i[a]=o[r]);n!==i.ISBN&&this.isBookExist(i,s)||(s[e.id]=i,this.setToLocalStorage(s))}},e.prototype.removeBook=function(t){var o=this.getBookByISBN(t)||{},e=this.getFromLocalStorage(),i=o.book;this.isBookExist(i)&&(e.splice(o.id,1),this.setToLocalStorage(e))},e.prototype.sortBy=function(t,o,e){t=t||"books",e=e||!1,o=o||"title";var i=this.getFromLocalStorage(t);return i.sort(function(t,e){var i=t[o],s=e[o];return s>i?-1:i>s?1:0}),e&&i.reverse(),i},e.prototype.setLibrarySettings=function(t){var o=this.getFromLocalStorage("librarySettings");o=o.length?o:{};for(var e in t)t.hasOwnProperty(e)&&(o[e]=t[e]);this.setToLocalStorage(o,"librarySettings")},e.prototype.validate=function(t,o){var e=!1;switch(t){case"title":case"author":/^[a-zа-яё0-9 \, -]+$/gi.test(o)&&(e=!0);break;case"genre":/^[a-zа-яё \, -]+$/gi.test(o)&&(e=!0);break;case"year":/^(\d{0,4})$/.test(o)&&(e=!0);break;case"ISBN":/(?=.{17}$)97(?:8|9)([ -])\d{1,5}\1\d{1,7}\1\d{1,6}\1\d$/gi.test(o)&&(e=!0);break;case"image":/(http:||https:)\/\//gi.test(o)&&(e=!0)}return e},e.prototype.liveResultInit=function(t){var o=["author","genre"],e={};if(t&&t.length)for(var i=0;i<o.length;i++){e[o[i]]=[];for(var s=0;s<t.length;s++)for(var n=0;n<t[s][o[i]].length;n++)-1===e[o[i]].indexOf(t[s][o[i]][n])&&e[o[i]].push(t[s][o[i]][n]);e[o[i]].sort(function(t,o){return o>t?-1:t>o?1:0}),this.setToLocalStorage(e[o[i]],o[i])}},e.prototype.liveResultRemove=function(t,o){var e=this.getFromLocalStorage(o),i=e.indexOf(t);e.splice(i,1),this.setToLocalStorage(e,o)},e.prototype.liveResultUpdate=function(t,o,e){var i=this.getFromLocalStorage(e),s=i.indexOf(o);i[s]=t,this.setToLocalStorage(i,e)},i.prototype={newBook:function(t){var o="",e="",i=0;if("object"==typeof t.author)for(i=0;i<t.author.length;i++)o+=t.author[i]+(i+1===t.author.length?"":", ");if("object"==typeof t.genre)for(i=0;i<t.genre.length;i++)e+=t.genre[i]+(i+1===t.genre.length?"":", ");var s="app.ui.editBookData(this)",n="app.ui.removeBook(this)",a='<div class="card_block"><div class="image_block"><img src="'+t.image+'" alt="'+t.title+'"></div><div class="info_block"><div class="info"><span class="info_title">title</span><span class="info_data">'+t.title+'</span></div><div class="info"><span class="info_title">author</span><span class="info_data">'+o+'</span></div><div class="info"><span class="info_title">genre</span><span class="info_data">'+e+'</span></div><div class="info"><span class="info_title">year</span><span class="info_data">'+t.year+'</span></div><div class="info"><span class="info_title">ISBN</span><span class="info_data">'+t.ISBN+'</span></div><div class="info"><span class="info_title">views</span><span class="info_data">'+t.views+'</span></div></div><div class="action_block"><div class="edit_block"><button name="'+t.ISBN+'" class="edit" on'+this.endEvent+'="'+s+'"><i class="material-icons">mode_edit</i></button></div><div class="remove_block"><button name="'+t.ISBN+'" class="remove" on'+this.endEvent+'="'+n+'"><i class="material-icons">delete_forever</i></button></div></div></div>';this.content.innerHTML+=a},createLiveResults:function(){for(var t,o,e=["author","genre"],i="",n="app.ui.selectLiveResult(this);",a="app.ui.editLiveResult(this);",r="app.ui.removeLiveResult(this);",l=0;l<e.length;l++){t=this.body.querySelector('.form_input[name="'+e[l]+'"]').nextSibling,o=s.getFromLocalStorage(e[l]),i="";for(var c=0;c<o.length;c++)i+='<li><input value="'+o[c]+'" readonly on'+this.endEvent+'="'+n+'" class="live_result"><span class="edit"><button type="button" on'+this.endEvent+'="'+a+'"class="edit_list"><i class="material-icons">mode_edit</i></button><button type="button" on'+this.endEvent+'="'+r+'" class="remove_list"><i class="material-icons">delete_forever</i></button></span></li>';t.innerHTML+=i}},find:function(t){return this.body.querySelector("."+t)},findAll:function(t){return this.body.querySelectorAll("."+t)},findParent:function(t,o,e){var i=t.parentNode;if(i.classList.contains(o)||"BODY"===i.tagName){if("BODY"===i.tagName)return;e(i)}else this.findParent(i,o,e)},booksFromStorage:function(t){t=t||s.getFromLocalStorage(),this.content.innerHTML="";for(var o=0;o<t.length;o++)this.newBook(t[o])},addNewBook:function(t,o){this.find("form").reset(),this.showBookPopup()},showBookPopup:function(t){this.find("popup_wrapper").classList.add("open"),this.find("popup").classList.add("open")},checkBeforeClosePopup:function(t,o){var e=this.find("popup_wrapper");(o.target===e||"close"===t)&&(this.closeBookPopup(),this.removeFocusOnInputs())},closeBookPopup:function(t,o){this.find("popup_wrapper").classList.remove("open"),this.find("popup").classList.remove("open"),this.bookId="",this.removeFocusOnInputs()},clearBookPopup:function(t,o){this.find("form").reset(),this.removeFocusOnInputs(),this.closeBookPopup()},removeFocusOnInputs:function(t,o){var e,i=this.findAll("form_input");for(e=0;e<i.length;e++)i[e].classList.remove("focus"),i[e].classList.remove("error");this.fucusedInput=""},focusOnInput:function(t,o){this.removeFocusOnInputs(t),o.target.classList.add("focus"),this.fucusedInput=o.target},looseFocusFromInput:function(t,o){var e=this.find("popup");o.target===e&&this.removeFocusOnInputs()},selectLiveResult:function(t){var o=new RegExp("\\b"+t.value+"\\b","gi");!o.test(this.fucusedInput.value)&&this.isReadonly(t)&&(this.fucusedInput.value?this.fucusedInput.value+=", "+t.value:this.fucusedInput.value=t.value)},isReadonly:function(t){var o=t.getAttribute("readonly");return null===o||void 0===o?!1:!0},editLiveResult:function(t){var o=t.parentNode.previousSibling,e=o.parentNode.parentNode.previousSibling;this.isReadonly(o)?(this.oldInput=o.value,o.removeAttribute("readonly"),o.focus(),t.classList.add("active")):(o.setAttribute("readonly",!0),s.liveResultUpdate(o.value,this.oldInput,e.name),this.oldInput="",t.classList.remove("active"))},removeLiveResult:function(t){var o=t.parentNode.parentNode,e=o.parentNode,i=o.firstChild.value,n=e.parentNode.firstChild.name;s.liveResultRemove(i,n),e.removeChild(o),e.children.length||this.removeFocusOnInputs()},setSorting:function(){var t=s.getFromLocalStorage("librarySettings"),o=t.sorting.type,e=t.sorting.reverse,i=s.sortBy("books",o,e);this.find("sort_variant").innerHTML=o,e&&this.find("sort_reverse").classList.toggle("active"),this.booksFromStorage(i)},toggleSortList:function(t,o){this.find("sort_button").classList.toggle("active"),this.find("sort_list").classList.toggle("open")},selectSortType:function(t,o){if("LI"===o.target.nodeName){var e,i=o.target.innerHTML,n=s.getFromLocalStorage("librarySettings"),a=n.sorting.reverse;this.find("sort_variant").innerHTML=i,n.sorting.type=i,s.setLibrarySettings(n),e=s.sortBy("books",i,a),this.booksFromStorage(e),this.toggleSortList()}},sortReverse:function(t,o){var e,i=s.getFromLocalStorage("librarySettings"),n=i.sorting.type;i.sorting.reverse=!i.sorting.reverse,s.setLibrarySettings(i),e=s.sortBy("books",n,i.sorting.reverse),this.booksFromStorage(e),this.find(t).classList.toggle("active")},editBookData:function(t){var o,e=this.findAll("form_input"),i={},n=s.getFromLocalStorage();if(n.length){o=s.getBookByISBN(t.name).id;for(var a=0;a<e.length;a++)i[e[a].name]=e[a],i[e[a].name].value=n[o][e[a].name];this.showBookPopup()}},removeBook:function(t){var o=t.parentNode.parentNode.parentNode;o.classList.add("hide"),s.removeBook(t.name)},saveBookData:function(t,o){for(var e=this.findAll("form_input"),i={},n="",a=0;a<e.length;a++){if(n=e[a].value,!this.validateBookData(e[a]))return;if("author"===e[a].name||"genre"===e[a].name){i[e[a].name]=[],n=n.split(",");for(var r=0;r<n.length;r++)n[r]=n[r].trim(),i[e[a].name].push(n[r])}i[e[a].name]=i[e[a].name]||n}s.newBook(i),this.setSorting(),this.closeBookPopup()},validateBookData:function(t){var o=s.validate(t.name,t.value);return o?(t.classList.remove("error"),!0):(t.classList.add("error"),!1)},handler:function(t){for(var o=0;o<n.cssAction.length;o++)if(this.classList.contains(n.cssAction[o].name)){n.cssAction[o].action(n.cssAction[o].name,t);break}}};var s=new e,n=new i;return{library:s,ui:n}}(window,document)});